<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta content="en-us" http-equiv="Content-Language" />
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>Watchlist Filter</title>
<style type="text/css">
.auto-style2 {
	margin-left: 0px;
	font-family: "Calibri Light";
}
.auto-style4 {
	border-width: 0px;
}
.auto-style7 {
	text-align: center;
	border-left-style: none;
	border-left-width: medium;
	border-right-style: solid;
	border-right-width: 1px;
	border-top-style: solid;
	border-top-width: 1px;
	border-bottom-style: solid;
	border-bottom-width: 1px;
	background-color: #978FF3;
}
.auto-style9 {
	text-align: left;
	font-size: medium;
	border-left-style: solid;
	border-left-width: 1px;
	border-right-style: none;
	border-right-width: medium;
	border-top-style: solid;
	border-top-width: 1px;
	border-bottom-style: solid;
	border-bottom-width: 1px;
	font-family: "Calibri Light";
	background-color: #978FF3;
}
.auto-style10 {
	text-align: center;
	border-left-style: none;
	border-left-width: medium;
	border-right-style: none;
	border-right-width: medium;
	border-top-style: solid;
	border-top-width: 1px;
	border-bottom-style: solid;
	border-bottom-width: 1px;
	background-color: #978FF3;
}
.auto-style11 {
	text-align: left;
	font-size: medium;
	border-left-style: none;
	border-left-width: medium;
	border-right-style: none;
	border-right-width: medium;
	border-top-style: solid;
	border-top-width: 1px;
	border-bottom-style: solid;
	border-bottom-width: 1px;
	font-family: "Calibri Light";
	background-color: #978FF3;
}
.auto-style12 {
	margin-right: 0px;
}
.auto-style13 {
	text-align: right;
}
.auto-style14 {
	text-align: center;
	font-size: medium;
	border-left-style: none;
	border-left-width: medium;
	border-right-style: none;
	border-right-width: medium;
	border-top-style: solid;
	border-top-width: 1px;
	border-bottom-style: solid;
	border-bottom-width: 1px;
	font-family: "Calibri Light";
	background-color: #978FF3;
}
.auto-style15 {
	font-size: medium;
	font-family: "Calibri Light";
}
.auto-style16 {
	text-align: left;
}
.auto-style21 {
	border-style: solid;
	border-width: 0px;
	font-family: "Calibri Light";
}
.auto-style28 {
	font-size: medium;
	font-family: "Calibri Light";
}
.auto-style32 {
	font-family: "Calibri Light";
	color: #D76D6D;
	border-left-style: solid;
	border-left-width: 1px;
	border-top-style: solid;
	border-top-width: 1px;
	border-bottom-style: solid;
	border-bottom-width: 1px;
	background-color: #EAEABF;
}
.auto-style33 {
	border-right-style: solid;
	border-right-width: 1px;
	border-top-style: solid;
	border-top-width: 1px;
	border-bottom-style: solid;
	border-bottom-width: 1px;
	color: #D76D6D;
	background-color: #EAEABF;
}
.auto-style34 {
	border-top-style: solid;
	border-top-width: 1px;
	border-bottom-style: solid;
	border-bottom-width: 1px;
	color: #D76D6D;
	background-color: #EAEABF;
}
.auto-style35 {
	font-family: "Calibri Light";
	color: #3E4BDC;
	border-top-style: solid;
	border-top-width: 1px;
	border-bottom-style: solid;
	border-bottom-width: 1px;
	background-color: #EAEABF;
}
.auto-style36 {
	margin-left: 13px;
}
.auto-style37 {
	border-style: solid;
	border-width: 1px;
}
.auto-style38 {
	border-style: solid;
	text-align: center;
	border-width: 1px;
	background-color: #FDFBDB;
}
.auto-style39 {
	border-style: solid;
	text-align: left;
	border-width: 1px;
	background-color: #FDFBDB;
}
.auto-style41 {
	font-family: "Calibri Light";
	color: #D76D6D;
	border-top-style: solid;
	border-top-width: 1px;
	border-bottom-style: solid;
	border-bottom-width: 1px;
	text-align: center;
	background-color: #EAEABF;
}
.auto-style42 {
	font-family: "Calibri Light";
	color: #D76D6D;
	border-top-style: solid;
	border-top-width: 1px;
	border-bottom-style: solid;
	border-bottom-width: 1px;
	text-align: left;
	background-color: #EAEABF;
}
.auto-style45 {
	color: #D76D6D;
}
.auto-style46 {
	font-family: "Calibri Light";
	color: #D76D6D;
	border-top-style: solid;
	border-top-width: 1px;
	border-bottom-style: solid;
	border-bottom-width: 1px;
	text-align: right;
	background-color: #EAEABF;
}
.auto-style47 {
	font-family: "Calibri Light";
	color: #D76D6D;
	border-top-style: solid;
	border-top-width: 1px;
	border-bottom-style: solid;
	border-bottom-width: 1px;
	background-color: #EAEABF;
}
.auto-style48 {
	border-style: solid;
	text-align: center;
	border-width: 1px;
	background-color: #FFFFFF;
}
.auto-style49 {
	border-style: solid;
	text-align: left;
	border-width: 1px;
	background-color: #FFFFFF;
}
.auto-style50 {
	text-align: right;
}
</style>
</head>

<body style="width: 1163px; height: 475px">

<div>

<?php

	$mysql_hostname = "localhost";
	$mysql_dbase = "stock_automate";
	$mysql_uname = "stockmarket1001";
	$mysql_psw = "pets2020life";


	//$link = mysqli($mysql_hostname, $mysql_uname, $mysql_psw);
	$link = new mysqli($hostname, $username, $password, $database);
	if (!$link) {
		die('Could not connect: ' . mysql_error());
	}

	//mysql_select_db($mysql_dbase, $link);

	$new_watchlistname = "";
	$exchange_id     = 0;
	$sector_id       = 0;
	$min_stock_value = 10;
	$max_stock_value = 69;
	$min_change_per  = -3;
	$max_change_per  = -7;

	//if method is PSOT
	if ($_SERVER["REQUEST_METHOD"] == "POST") {

		$new_watchlistname = $_POST["new_watchlistname"];
		$exchange_id       = $_POST["exchange_id"];
		$sector_id         = $_POST["sector_id"];

		$min_stock_value = $_POST["min_stock_value"];
		$max_stock_value = $_POST["max_stock_value"];

		$min_change_per = $_POST["min_change_per"];
		$max_change_per = $_POST["max_change_per"];
		$first_time     = $_POST["first_time"];
		$selected_date  = $_POST["selected_date"];

		$sel_year  = $_POST["sel_year"];
		$sel_month = $_POST["sel_month"];
		$sel_day   = $_POST["sel_day"];


		$date_temp = new DateTime($sel_month.'/'.$sel_day.'/'.$sel_year);
		$selected_date = date_format($date_temp, 'Y_m_d');
		$Filter = $_POST["Filter"];
	}
?>

<form action="index.php" class="auto-style12" method="post" style="width: 1128px; height: 457px" target="_self" name="todays_report">

	<div class="auto-style16">
		<br class="auto-style28" />
		<span class="auto-style28"><strong>Watchlist Report : <?php echo date('Y-m-d l H:i:s'); ?></strong></span></div>
		<br>
	<div style="height: 66px; width: 1129px">
		<table align="center" cellspacing="0" class="auto-style4" style="width: 100%; height: 15px">
			<tr>
				<td class="auto-style9" style="width: 65px">Exhcange:</td>
				<td class="auto-style10" style="width: 123px">

<?php
	//first time page load, setup everything
	if ($exchange_id == 0 || $sector_id == 0) {
		$exchange_id = 1;
		$sector_id = 1;
	}
	if ($sel_year ==0 || $sel_month == 0 || $sel_day == 0) {
		$today = getdate();
		$sel_day = $today[mday];
		$sel_month = $today[mon];
		$sel_year = $today[year];

		$date_temp = new DateTime($sel_month.'/'.$sel_day.'/'.$sel_year);
		$selected_date = date_format($date_temp, 'Y_m_d');
	}

	$selected_exchange_name = "nasdaq";
	$selected_sector_name   = "Energy";

		echo '<select name="exchange_id" style="width: 95px" class="auto-style15">';
/*
		$sql  = 'SELECT * FROM market_center order by rec_id;';
		$result = mysql_query($sql, $link);
		while ($row = mysql_fetch_assoc($result)) {
			if ($row['rec_id'] == $exchange_id) {
				echo '<option selected="selected" value="'.$row['rec_id'].'">'.$row['name'].'</option><br>';
				$selected_exchange_name = $row['name'];
			} else {
				echo '<option value="'.$row['rec_id'].'">'.$row['name'].'</option><br>';
			}
		}

		mysql_free_result($result);
		*/
		echo '</select></td>';

		echo '<td class="auto-style14" style="width: 71px">Sector</td>';
		echo '<td class="auto-style10" style="width: 205px">';
		echo '<select name="sector_id" style="width: 189px" class="auto-style15">';
		/*
		$sql  = 'SELECT * FROM stock_sector order by rec_id;';
		$result = mysql_query($sql, $link);

		while ($row = mysql_fetch_assoc($result)) {
			if ($row['rec_id'] == $sector_id) {
				echo '<option selected="selected" value="'.$row['rec_id'].'">'.$row['sector_name'].'</option><br>';
				$selected_sector_name = $row['sector_name'];
			} else {
				echo '<option value="'.$row['rec_id'].'">'.$row['sector_name'].'</option><br>';
			}
		}
		mysql_free_result($result);
		*/
		echo '</select></td>';
?>
				<td class="auto-style11" style="width: 70px">Min Value </td>
				<td class="auto-style10" style="width: 73px">
				<input name="min_stock_value" style="width: 41px" type="text" class="auto-style15" value="<?php echo $min_stock_value; ?>" /></td>
				<td class="auto-style11" style="width: 71px">Max value</td>
				<td class="auto-style10" style="width: 84px">
				<input name="max_stock_value" style="width: 52px; height: 22px;" type="text" class="auto-style15" value="<?php echo $max_stock_value; ?>" /></td>
				<td class="auto-style11" style="width: 93px">Min change %</td>
				<td class="auto-style10" style="width: 89px">
				<input name="min_change_per" style="width: 52px" type="text" class="auto-style15" value="<?php echo $min_change_per; ?>" /></td>
				<td class="auto-style11" style="width: 98px">Max change %</td>
				<td class="auto-style7">
				<input name="max_change_per" style="width: 52px" type="text" class="auto-style15" value="<?php echo $max_change_per; ?>" /></td>
			</tr>
		</table>

			<table style="width: 100%; height: 15px">
			<tr>
				<td class="auto-style28">&nbsp;</td>
				<td class="auto-style28">&nbsp;</td>
				<td style="width: 671px" class="auto-style50">&nbsp;</td>
				<td class="auto-style13">

<div style="width: 319px; height: 27px">


<?php

// To print Month

$info = cal_info(0);
$arrlength = count($info[months]);

/*for($x = 1; $x <= $arrlength; $x++) {
    echo $info[months][$x];
    echo "<br>";
}*/


	$mon_str = "";

	for ($mon = 1; $mon <= $arrlength; $mon++) {
		//add year to listbox
		if ($mon == $sel_month) {
			$mon_str .= '<option selected= "selected" value="'.$mon.'">'.$info[months][$mon].'</option>';
		} else {
			$mon_str .= '<option value="'.$mon.'">'.$info[months][$mon].'</option>';
		}
	}
	echo '<select name="sel_month" style="width: 90px">';
	echo $mon_str;
	echo '</select>';

	//print days of month
	echo '<select name="sel_day" style="width: 41px">';
	for ($day = 1; $day <= 31; $day++) {
		if ($day == $sel_day) {
			echo '<option selected="selected" value="'.$day.'">'.$day.'</option>';
		} else {
			echo '<option value="'.$day.'">'.$day.'</option>';
		}
	}
	echo '</select>';

	//year print
	$year_str = "";
	for ($year = 2015; $year < $sel_year+1; $year++) {
		//add year to listbox
		if ($year == $sel_year) {
			$year_str .= '<option selected= "selected" value="'.$year.'">'.$year.'</option>';
		} else {
			$year_str .= '<option value="'.$year.'">'.$year.'</option>';
		}
	}
	echo '<select name="sel_year" style="width: 61px">';
	echo $year_str;
	echo '</select>';
?>
<br class="auto-style28" />
</div>
				</td>

				<td class="auto-style13">
				<input class="auto-style2" type = "submit" name="Filter" type="button" value="Apply Filter" /></td>
			
			</tr>
		</table>
	</div>

	<div style="height: auto">
		<table cellpadding="0" cellspacing="0" class="auto-style4" style="width: 100%">
			<tr>
				<td class="auto-style32"><strong><?php echo $selected_exchange_name.' ( '.$selected_sector_name.' )'; ?></strong></td>
				<td class="auto-style34">&nbsp;</td>
				<td class="auto-style46">Value:&nbsp;&nbsp; </td>
				<td class="auto-style41" style="width: 41px">$<?php echo $min_stock_value; ?></td>
				<td class="auto-style42" style="width: 66px">To $<?php echo $max_stock_value; ?></td>
				<td class="auto-style46">Range&nbsp; </td>
				<td class="auto-style47" style="width: 36px"><?php echo $min_change_per; ?>%</td>
				<td class="auto-style47" style="width: 21px">to</td>
				<td class="auto-style35"><span class="auto-style45"><?php echo $max_change_per; ?> %</span></td>
				<td class="auto-style33">&nbsp;</td>
			</tr>
		</table>
	</div>
	<div style="height: auto">
		<table cellpadding="0" cellspacing="0" class="auto-style21" style="width: 100%">
			<tr>
				<td class="auto-style39" style="width: 102px">Symbol</td>
				<td class="auto-style39" style="width: 418px">Company</td>
				<td class="auto-style38" style="width: 125px">Previous Day close</td>
				<td class="auto-style38" style="width: 106px">Last Traded</td>
				<td class="auto-style38" style="width: 96px">Change $</td>
				<td class="auto-style38" style="width: 81px">Change %</td>
				<td class="auto-style38">Volume</td>
			</tr>

<?php
	if (isset($Filter) || $first_time == 0) {
		//FROM 2014_11_17_'.$selected_exchange_name.
		//$table_name = date('Y_m_d').'_'.$selected_exchange_name;
		$selected_exchange_name = "nyse";
$sector_id = 0;

		$table_name = "nyse_daily_history"; //$selected_date.'_'.$selected_exchange_name;

		$sql = 'SELECT * from '.$table_name.' where symbol in (select symbol as tech_symbol from '.$selected_exchange_name .' where sector = '.$sector_id.') and  last_traded > '.$min_stock_value.' and last_traded < '.$max_stock_value.'
 and change_per > '.$max_change_per.' and change_per < '.$min_change_per.' and abs(change_value) > 0.32 group by symbol order by volume desc limit 20';


//echo $sql;

		$result = mysql_query($sql, $link);

		if (!$result) {
			echo "DB Error-case2, could not query the database\n";
			echo 'MySQL Error: ' . mysql_error();
			exit;
		}
//http://finance.yahoo.com/q?s=aapl&ql=1
		while ($row = mysql_fetch_assoc($result)) {
			echo '<tr>';
				echo '<td class="auto-style49" style="width: 102px">';
				echo '<a href="http://finance.yahoo.com/q?s='.$row['symbol'].'&ql=1" target="_blank">'.$row['symbol'].'</a></td>';
				echo '<td class="auto-style49" style="width: 418px">'.$row['symbol'].'</td>';
				echo '<td class="auto-style48" style="width: 125px">'.$row['open'].'</td>';
				echo '<td class="auto-style48" style="width: 106px">'.$row['high'].'</td>';
				echo '<td class="auto-style48" style="width: 96px">'.$row['low'].'</td>';
				echo '<td class="auto-style48" style="width: 81px">'.$row['close'].'</td>';
				echo '<td class="auto-style48">'.$row['volume'].'</td>';
			echo '</tr>';
		}
	}
?>
		</table>
	</div>
	<br class="auto-style28" />


<div style="height: auto">
<table class="auto-style4" style="width: 100%; height: 34px">
<tr>
<td class="auto-style37" style="width: 139px">Watchlist Name</td>
<td class="auto-style37" valign="bottom">
<input name="new_watchlistname" size="30" style="width: 271px; height: 25px" type="text" value="" />
<input class="auto-style36" name="add_watchlist" style="width: 122px" type="submit" value="Add To Watch list" /></td>
</tr>
</table>
</div>
<input type="hidden" name="first_time" id="first_time" value="1" /> 
	<br class="auto-style28" />
	<br class="auto-style28" />
	<br class="auto-style28" />
	<br class="auto-style28" />
	<br class="auto-style28" />
	<br class="auto-style28" />
	<br class="auto-style28" />
</form>

<?php
//build selected items and add into watch list table
if ($new_watchlistname != "") {
	echo "<br>$add_watchlist:".$new_watchlistname;
}

if ($result) {
	mysql_free_result($result);
	mysql_close($link);
}
?>
</div>

</body>

</html>
